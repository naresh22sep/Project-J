{% extends "layouts/admin_layout.html" %}

{% block title %}{{ user.first_name }} {{ user.last_name }} - Activity Log{% endblock %}

{% block content %}
<!-- Activity Log Header -->
<div class="dashboard-header">
    <div class="row">
        <div class="col-sm-6">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('superadmin.dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('superadmin.users') }}">Users</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('superadmin.user_detail', user_id=user.id) }}">{{ user.first_name }} {{ user.last_name }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Activity Log</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">Activity Log</h1>
            <p class="text-muted">Security events and user activity for {{ user.first_name }} {{ user.last_name }}</p>
        </div>
        <div class="col-sm-6 text-sm-end">
            <div class="btn-group">
                <a href="{{ url_for('superadmin.user_detail', user_id=user.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to User
                </a>
                <button class="btn btn-outline-primary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print Log
                </button>
            </div>
        </div>
    </div>
</div>

<!-- User Info Card -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        {% if user.avatar_url %}
                            <img src="{{ user.avatar_url }}" alt="User Avatar" class="rounded-circle" width="60" height="60">
                        {% else %}
                            <div class="avatar-placeholder rounded-circle mx-auto d-flex align-items-center justify-content-center" 
                                 style="width: 60px; height: 60px; background-color: #f8f9fa; border: 2px solid #dee2e6;">
                                <i class="fas fa-user fa-lg text-muted"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-8">
                        <h5 class="mb-1">{{ user.first_name }} {{ user.last_name }}</h5>
                        <p class="mb-1 text-muted">{{ user.email }}</p>
                        <p class="mb-0 small text-muted">User ID: {{ user.id }} | Username: {{ user.username }}</p>
                    </div>
                    <div class="col-md-2 text-end">
                        <span class="badge {% if user.is_active %}bg-success{% else %}bg-danger{% endif %} mb-1">
                            {% if user.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                        <br>
                        {% set primary_role = user.get_roles()[0] if user.get_roles() else None %}
                        {% if primary_role %}
                            <span class="badge 
                                {% if primary_role.name == 'superadmin' %}bg-danger
                                {% elif primary_role.name == 'admin' %}bg-primary
                                {% elif primary_role.name == 'consultancy' %}bg-success
                                {% elif primary_role.name == 'jobseeker' %}bg-info
                                {% else %}bg-secondary{% endif %}">
                                {{ primary_role.name.title() }}
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activity Log Table -->
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Activity Log
                    <span class="badge bg-secondary ms-2">{{ activity_logs.total }} events</span>
                </h5>
            </div>
            <div class="col-auto">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="filterEvents('all')">All</button>
                    <button class="btn btn-outline-success" onclick="filterEvents('login')">Logins</button>
                    <button class="btn btn-outline-warning" onclick="filterEvents('modify')">Modifications</button>
                    <button class="btn btn-outline-danger" onclick="filterEvents('security')">Security</button>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if activity_logs.items %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Timestamp</th>
                            <th>Event Type</th>
                            <th>Severity</th>
                            <th>IP Address</th>
                            <th>User Agent</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in activity_logs.items %}
                        <tr class="event-row" data-event-type="{{ log.event_type }}">
                            <td>
                                <div class="fw-bold">{{ log.created_at.strftime('%Y-%m-%d') }}</div>
                                <small class="text-muted">{{ log.created_at.strftime('%H:%M:%S') }}</small>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if 'login' in log.event_type.lower() %}
                                        {% if 'success' in log.event_type.lower() %}bg-success
                                        {% else %}bg-danger{% endif %}
                                    {% elif 'password' in log.event_type.lower() %}bg-warning
                                    {% elif 'modified' in log.event_type.lower() %}bg-info
                                    {% else %}bg-secondary{% endif %}">
                                    {{ log.event_type.replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if log.severity == 'high' %}bg-danger
                                    {% elif log.severity == 'medium' %}bg-warning
                                    {% elif log.severity == 'low' %}bg-info
                                    {% else %}bg-secondary{% endif %}">
                                    {{ log.severity.title() }}
                                </span>
                            </td>
                            <td>
                                <code class="small">{{ log.ip_address or 'Unknown' }}</code>
                            </td>
                            <td>
                                <span class="small text-muted" title="{{ log.user_agent or 'Unknown' }}">
                                    {% if log.user_agent %}
                                        {% if 'Chrome' in log.user_agent %}
                                            <i class="fab fa-chrome text-warning"></i> Chrome
                                        {% elif 'Firefox' in log.user_agent %}
                                            <i class="fab fa-firefox text-danger"></i> Firefox
                                        {% elif 'Safari' in log.user_agent %}
                                            <i class="fab fa-safari text-info"></i> Safari
                                        {% elif 'Edge' in log.user_agent %}
                                            <i class="fab fa-edge text-primary"></i> Edge
                                        {% else %}
                                            <i class="fas fa-globe text-muted"></i> Browser
                                        {% endif %}
                                    {% else %}
                                        <i class="fas fa-question text-muted"></i> Unknown
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if log.details %}
                                    <button class="btn btn-sm btn-outline-info" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#details-{{ log.id }}" 
                                            aria-expanded="false">
                                        <i class="fas fa-info-circle"></i> Details
                                    </button>
                                    <div class="collapse mt-2" id="details-{{ log.id }}">
                                        <div class="card card-body small">
                                            <pre class="mb-0"><code>{{ log.details_json if log.details_json else log.details }}</code></pre>
                                        </div>
                                    </div>
                                {% else %}
                                    <span class="text-muted small">No details</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Activity Found</h5>
                <p class="text-muted">This user has no recorded activity events.</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Pagination -->
    {% if activity_logs.pages > 1 %}
    <div class="card-footer">
        <nav aria-label="Activity log pagination">
            <ul class="pagination pagination-sm justify-content-center mb-0">
                {% if activity_logs.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('superadmin.user_activity_log', user_id=user.id, page=activity_logs.prev_num) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                {% endif %}
                
                {% for page_num in activity_logs.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != activity_logs.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('superadmin.user_activity_log', user_id=user.id, page=page_num) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">…</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if activity_logs.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('superadmin.user_activity_log', user_id=user.id, page=activity_logs.next_num) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        
        <div class="text-center mt-2">
            <small class="text-muted">
                Showing {{ activity_logs.per_page * (activity_logs.page - 1) + 1 }} to 
                {{ activity_logs.per_page * (activity_logs.page - 1) + activity_logs.items|length }} of 
                {{ activity_logs.total }} events
            </small>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterEvents(type) {
    const rows = document.querySelectorAll('.event-row');
    
    rows.forEach(row => {
        const eventType = row.dataset.eventType.toLowerCase();
        let show = false;
        
        switch(type) {
            case 'all':
                show = true;
                break;
            case 'login':
                show = eventType.includes('login');
                break;
            case 'modify':
                show = eventType.includes('modified') || eventType.includes('updated') || eventType.includes('changed');
                break;
            case 'security':
                show = eventType.includes('failed') || eventType.includes('locked') || eventType.includes('suspicious') || eventType.includes('violation');
                break;
        }
        
        row.style.display = show ? '' : 'none';
    });
    
    // Update active button
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

// Auto-refresh every 30 seconds
setInterval(function() {
    if (document.visibilityState === 'visible') {
        location.reload();
    }
}, 30000);
</script>
{% endblock %}